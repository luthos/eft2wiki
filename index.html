<!DOCTYPE html>
<html>
<head>
 <meta charset="utf-8">
 <title>EFT to Mediawiki conversion tool</title>
 <style>
  body { font: small sans-serif; }
  table { width: 100%; }
  textarea { width: 100%; height: 180pt; }
  div#previewarea { width:100%; min-height: 180pt; border: 1pt solid lightgray; padding: 2pt; margin: 1pt; }
  td { vertical-align:top; padding: 5px; width: 50%; }
  h1, h2, h3 { margin: 0; line-height: 100%; }
  dt { font-weight: bold; }
  hr { clear: both; border: 1px solid lightgray; width: 40%; margin: 12pt auto; height: 0px;  }
 </style>
 <script>
  function modified() {
   var pa = document.getElementById("previewarea");
   var ta = document.getElementById("pastearea");
   var ma = document.getElementById("mediawiki");
   var da = document.getElementById("debugarea");
   var obj = parseEFT(ta.value);
   da.value = JSON.stringify(obj, null, 4);
   ma.value = makeMediaWiki(obj);
   pa.innerHTML = makeHTML(obj);
  }
  ////////////// Bloody parser...
  function parseEFT(text) {
   var lines = text.split("\n");
   var firstline = /^\[([^,]+), (.+)\]$/.exec(lines[0]);
   var obj = {
        //originaltext: text,
        //originallines: lines,
        shiptype: firstline[1],
        fitname: firstline[2],
        lows: [],
        meds: [],
        highs: [],
        rigs: [],
        subsystems: [],
        drones: [] };
   var index = 1; // current line of lines[]
   var todolist = [obj.lows, obj.meds, obj.highs, obj.rigs, obj.subsystems, obj.drones];
   var todoindex = 0; // where in the above todolist we are at
   var repeated = 0; // how many times an item is repeated
   for(; index < lines.length; index += 1) {
    if(lines[index] === "") {
     todoindex += 1;
     // EFT likes to double the space before drones, so this is a hack to accept
     // an extra space between subsystems and drones for drone strat cruisers...
     // were normally that extra space is absorbed by subsystems
     if(todoindex === 5 && lines[index] === "") {
      index += 1; // eat an extra line! double space between subs and drones
     }
    } else {
     for(repeated = 1; lines[index+1] === lines[index]; repeated += 1) {
      index += 1;
     }
     todolist[todoindex].push({ repeats: repeated, type: lines[index] });
    }
   }
   // EFT likes to x the drones..
   for(index=0; index < obj.drones.length; index++) {
    var m = /^(.+) x([2345])$/.exec(obj.drones[index].type);
    if(m != null) {
     obj.drones[index] = { repeats: parseInt(m[2]) * obj.drones[index].repeats, type: m[1] };
    }
   }
   // Parse out any ammo in highs or meds
   var parseCharges = function(ch) {
    for(index=0; index < ch.length; index++) {
     var m = /^(.+), (.+)$/.exec(ch[index].type);
     if(m != null) {
      ch[index].type = m[1];
      ch[index].charge = m[2];
     }
    }
   };
   parseCharges(obj.highs);
   parseCharges(obj.meds);
   return obj;
  }
  ////////////// MediaWiki renderer
  function makeMediaWiki(obj) {
   var str = "=== " + obj.fitname + "===\n\n";
   var i;
   var printContents = function(wh, skipRepeats) {
    for(i = 0; i < wh.length; i+=1) {
     str += ":";
     if(skipRepeats !== true) {
      str += wh[i].repeats + " x ";
     }
     str += wh[i].type;
     if(wh[i].charge != null) {
      str += " (" + wh[i].charge + ")";
     }
     str += "\n";
    }
   };
   if(obj.subsystems.length > 0) {
    str += ";Subsystems\n"; printContents(obj.subsystems, true);
   }
   str += ";High\n"; printContents(obj.highs);
   str += ";Mid\n"; printContents(obj.meds);
   str += ";Low\n"; printContents(obj.lows);
   if(obj.rigs.length > 0) {
    str += ";Rigs\n";   printContents(obj.rigs);
   }
   if(obj.drones.length > 0) {
    str += ";Drones\n"; printContents(obj.drones);
   }
   return str;
  }
  ////////////// HTML renderer
  function makeHTML(obj) {
   var str = "<h3>" + obj.fitname + "</h3><dl>";
   var i;
   var printContents = function(wh, skipRepeats) {
    for(i = 0; i < wh.length; i+=1) {
     str += "<dd>";
     if(skipRepeats !== true) {
      str += wh[i].repeats + " x ";
     }
     str += wh[i].type;
     if(wh[i].charge != null) {
      str += " (" + wh[i].charge + ")";
     }
     str += "</dd>";
    }
   };
   if(obj.subsystems.length > 0) {
    str += "<dt>Subsystems</dt>"; printContents(obj.subsystems, true);
   }
   str += "<dt>High</dt>"; printContents(obj.highs);
   str += "<dt>Mid</dt>"; printContents(obj.meds);
   str += "<dt>Low</dt>"; printContents(obj.lows);
   if(obj.rigs.length > 0) {
    str += "<dt>Rigs</dt>";   printContents(obj.rigs);
   }
   if(obj.drones.length > 0) {
    str += "<dt>Drones</dt>"; printContents(obj.drones);
   }
   str += "</dl>";
   return str;
  }
 </script>
</head>

<body>

<form>
<table>
<tr>
<td>

 <h2>Paste EFT textblock here:</h2>
 <textarea id="pastearea" autofocus onChange="modified()" onKeyUp="modified()"></textarea>

 <hr>
 
 MediaWiki code (ctrl-a, ctrl-c is your friend)<br>
 <textarea id="mediawiki" readonly></textarea>

 <hr>
 
 <a href="#" onClick="document.getElementById('debugarea').style.display = ''; return false;">Show debugging JSON</a><br>
 <textarea id="debugarea" style="display:none" readonly></textarea>
 
</td>
<td>

 Preview<br>
 <div id="previewarea"></div>

</td> 
</tr>
</table>


</form>

</body>
</html>

